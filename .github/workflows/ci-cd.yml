name: CI/CD Pipeline

on:
    pull_request:
        branches: [ main ]
        types: [ opened, synchronize, reopened ]

permissions:
    contents: write

jobs: 
    lint:
        runs-on: ubuntu-latest
        steps: 
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Set up .NET
              uses: actions/setup-dotnet@v3
              with:
                dotnet-version: |
                  7.0.x
                  8.0.x
            - name: Install dependencies
              run: dotnet restore HotelReservationSystem/HotelReservationSystem.sln
            - name: Run code analysis
              run: dotnet build HotelReservationSystem/HotelReservationSystem.sln --no-restore

    security-scan:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3
          - name: Set up .NET
            uses: actions/setup-dotnet@v3
            with:
              dotnet-version: |
                7.0.x
                8.0.x
          - name: Install dependencies
            run: dotnet restore HotelReservationSystem/HotelReservationSystem.sln
          - name: Run security analysis
            run: dotnet build HotelReservationSystem/HotelReservationSystem.sln --no-restore

    test: 
        runs-on: ubuntu-latest
        
        services:
          sqlserver:
            image: mcr.microsoft.com/mssql/server:2022-latest
            env:
              ACCEPT_EULA: Y
              SA_PASSWORD: YourStrong@Passw0rd123
            ports:
              - 1433:1433
            options: >-
              --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd123 -C -Q 'SELECT 1'"
              --health-interval 10s
              --health-timeout 5s
              --health-retries 10
              --health-start-period 30s
        
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Set up .NET
              uses: actions/setup-dotnet@v3
              with:
                dotnet-version: |
                  7.0.x
                  8.0.x
            - name: Install dependencies
              run: dotnet restore HotelReservationSystem/HotelReservationSystem.sln
            - name: Create database
              run: |
                sleep 10
                docker exec $(docker ps -q --filter ancestor=mcr.microsoft.com/mssql/server:2022-latest) \
                  /opt/mssql-tools18/bin/sqlcmd \
                  -S localhost -U sa -P 'YourStrong@Passw0rd123' -C \
                  -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'HotelReservationDB') CREATE DATABASE HotelReservationDB"
            - name: Run tests
              env:
                ConnectionStrings__Default: "Server=localhost,1433;Database=HotelReservationDB;User Id=sa;Password=YourStrong@Passw0rd123;TrustServerCertificate=true;"
              run: dotnet test HotelReservationSystem/HotelReservationSystem.sln --no-restore --verbosity normal

    build:
        runs-on: ubuntu-latest
        needs: [test]
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Set up .NET
              uses: actions/setup-dotnet@v3
              with:
                dotnet-version: |
                  7.0.x
                  8.0.x
            - name: Install dependencies
              run: dotnet restore HotelReservationSystem/HotelReservationSystem.sln
            - name: Build solution
              run: dotnet build HotelReservationSystem/HotelReservationSystem.sln --configuration Release --no-restore
            - name: Publish artifacts
              run: dotnet publish HotelReservationSystem/HotelReservationSystem.Web/HotelReservationSystem.Web.csproj --configuration Release --output ./publish
            - name: Upload artifact
              uses: actions/upload-artifact@v3
              with:
                name: published-app
                path: ./publish

    release:
        runs-on: ubuntu-latest
        needs: [build]
        steps:
            - name: Download artifact
              uses: actions/download-artifact@v3
              with:
                name: published-app
                path: ./publish
            - name: Display release info
              run: echo "Release step - tutaj dodaj deployment do serwera lub chmury."